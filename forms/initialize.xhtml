<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:tei="http://www.tei-c.org/ns/1.0" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <title>Syriaca.org: Create New Record</title>
        <meta name="author" content="wsalesky at gmail.com"/>
        <meta name="description" content="Search Controlled Vocabularies"/>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"/>
        <link rel="stylesheet" type="text/css" href="../resources/css/xforms.css"/>
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"/>
        <!-- jquery -->
        <script type="text/javascript" charset="utf-8" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">/**/</script>
        
        <!-- Latest compiled and minified JavaScript -->
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"/>
    </head>
    <body class="soria" style="margin:30px;">
        <div>
            <div style="display:none">
                <xf:model id="m-initialize">
                    <!-- Select record type, generate new id, increment from id list (update syr-ids.xml with new id) -->
                    <!-- As soon as the new record is created the new id will be saved back to syr-ids via post, so it will be available to the next user -->
                    <!-- Show current highest id? for each section -->
                    <xf:instance xmlns="" id="i-ids" src="../services/syr-ids.xml"/>
                    <!-- Template used for building optional elements. May be a better way to handle that  -->
                    <xf:instance xmlns="" id="i-new-id">
                        <data>
                            <id type="" uri="" num=""/>
                        </data>
                    </xf:instance>
                    <xf:instance xmlns="" id="i-sumbission">
                        <data>
                            <message/>
                        </data>
                    </xf:instance>
                    <!-- when data type is selected load place/person rec as subform? 
                    id type="work" id="http://syriaca.org/work/2077" num="2077"-->

                    <!-- On 'load form' or change? send increment id submission to xquery to icrement that id, and update the new id instance? -->
                    <xf:submission id="s-increment-uri" resource="../services/increment-uri.xql" ref="instance('i-new-id')" replace="none" method="post">
                        <xf:action ev:event="xforms-submit-done">
                            <xf:reset model="model('m-initialize')"/>
                        </xf:action>
                        <xf:action ev:event="xforms-submit-error">
                            <xf:message level="modal">Error saving new URI.</xf:message>
                        </xf:action>
                    </xf:submission>
                    <!-- Recalculate the next available uri -->
                    <xf:submission id="s-recalculate-uri" resource="../services/list-ids.xql" method="get" replace="instance" targetref="instance('i-ids')"/>
                </xf:model>
            </div>
            <!-- List all existing titles -->
            <div class="section">
                <xf:switch id="edit-recs">
                    <xf:case id="initialize-new-rec" selected="true()">
                        <xf:submit class="btn btn-default pull-right" submission="s-recalculate-uri" appearance="minimal">
                            <xf:label>Recalculate next available URI</xf:label>
                        </xf:submit>
                        <h1>Create New Syrica.org Record</h1>
                        <p class="text-muted">Instructions, best practices, could be a modal pop up.</p>
                        <!-- 
                            Two types of actions will eventually have to happen here:
                            edit and create new
                            currently dealing only with create new
                            Also, would like to have full entry and 'quick' in the style of a spreadsheet, each row is a new record. 
                        -->
                        <xf:select1 ref="instance('i-new-id')/id/@type">
                            <xf:label>Select new record type:</xf:label>
                            <xf:itemset ref="instance('i-ids')//div">
                                <xf:label ref="@class"/>
                                <xf:value ref="@class"/>
                            </xf:itemset>
                            <xf:action ev:event="xforms-value-changed">
                                <xf:setvalue ref="instance('i-new-id')/id/@num" value="instance('i-ids')//id[@type = instance('i-new-id')/id/@type]/@num + 1"/>
                                <xf:setvalue ref="instance('i-new-id')/id/@uri" value="concat('http://syriaca.org/',instance('i-new-id')/id/@type,'/',instance('i-ids')//id[@type = instance('i-new-id')/id/@type]/@num + 1)"/>
                            </xf:action>
                        </xf:select1>
                        <br/>
                        <xf:group ref="instance('i-new-id')/id[@type != '']">
                            <p class="indent">You are creating a new <strong>
                                    <xf:output ref="instance('i-new-id')/id/@type"/>
                                </strong> with Syriaca.org URI of <strong>
                                    <xf:output ref="instance('i-new-id')/id/@uri"/>
                                </strong>
                            </p>
                            <xf:submit class="btn btn-default indent" submission="s-increment-uri" appearance="minimal">
                                <xf:label>Confirm</xf:label>
                                <!-- Trigger, saves new id to syr-ids via increment-uri.xql -->
                                <!-- Loads new form as subform -->
                                <xf:action ev:event="DOMActivate">
                                    <xf:load show="embed" targetid="subform" resource="form.xq?form=add-place.xhtml"/>
                                    <xf:toggle case="edit-new-rec"/>
                                </xf:action>
                            </xf:submit>
                        </xf:group>
                    </xf:case>
                    <xf:case id="edit-new-rec">
                        <xf:group id="subform"/>
                    </xf:case>
                </xf:switch>
            </div>
        </div>
    </body>
</html>